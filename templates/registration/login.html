<div class="modal fade" id="janela">
  <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg rounded-4">
          <div class="modal-header bg-custom-1 text-white">
              <h2 class="modal-title" id="modalTitle">Login</h2>
              <button type="button" class="btn-close btn-close-black" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">

              {% if form.errors %}
              <div class="alert alert-danger" id="loginError" role="alert">
                  <p>Ops! Parece que seu login ou senha estão incorretos. <br> Por favor, verifique e tente novamente.</p>
              </div>
              {% endif %}
              
              {% if user.is_authenticated %}
              <p class="text-muted">Você já está autenticado. <a href="{% url 'logout' %}">Sair</a></p>
              {% else %}
              <div id="loginContainer">
                  <div class="login">
                      <form method="post" class="formLogin" action="{% url 'login' %}">
                          {% csrf_token %}
                          <p class="text-muted">Digite os seus dados de acesso no campo abaixo.</p>

                          <label for="user_type" class="form-label">Selecione o tipo de usuário:</label>
                          <select id="user_type" name="user_type" class="form-select mb-3" required onchange="applyMaskAndShowFields()">
                              <option value="" disabled selected>Selecione...</option>
                              <option value="administrador">Administrador</option>
                              <option value="instituicao">Instituição</option>
                              <option value="profissional">Profissional</option>
                          </select>

                          <div id="loginFields" class="mt-3" style="display:none;">
                              <div class="mb-3">
                                  <label for="username" class="form-label">Usuário</label>
                                  <input type="text" id="username" name="username" class="form-control rounded-3" required>
                              </div>
                              <div class="mb-3">
                                  <label for="password" class="form-label">Senha</label>
                                  <div class="position-relative">
                                      <input type="password" id="password" name="password" class="form-control rounded-3 pe-5" required>
                                      <i class="bi bi-eye position-absolute top-50 end-0 translate-middle-y me-3 cursor-pointer"
                                         id="togglePassword" onclick="togglePasswordVisibility()"
                                         style="cursor: pointer; font-size: 1.2rem;"></i>
                                  </div>
                              </div>
                          </div>
                          
                          <div class="d-flex flex-column justify-content-center align-items-center gap-3">
                              <a href="{% url 'password_reset' %}" class="text-primary">Esqueci minha senha</a>
                              <input type="submit" value="Acessar" class="btn btn-custom btn-text-color px-4 w-100 rounded-3" />
                          </div>
                      </form>
                  </div>
              </div>
              {% endif %}
          </div>
      </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const userType = document.getElementById("user_type");
      const usernameField = document.getElementById("username");
      const loginFields = document.getElementById("loginFields");
      const passwordField = document.getElementById("password");
      const toggleIcon = document.getElementById("togglePassword");
  
      userType.addEventListener("change", function () {
          loginFields.style.display = "block";
          usernameField.value = "";
  
          if (userType.value === "instituicao") {
              usernameField.placeholder = "Digite o CNPJ (xx.xxx.xxx/xxxx-xx)";
              usernameField.setAttribute("inputmode", "numeric");
              applyMask(usernameField, "00.000.000/0000-00");
          } else if (userType.value === "profissional") {
              usernameField.placeholder = "Digite o CPF (xxx.xxx.xxx-xx)";
              usernameField.setAttribute("inputmode", "numeric");
              applyMask(usernameField, "000.000.000-00");
          } else {
              usernameField.placeholder = "Digite seu login";
              usernameField.removeAttribute("inputmode");
              usernameField.value = "";
          }
      });
  
      toggleIcon.addEventListener("click", function () {
          if (passwordField.type === "password") {
              passwordField.type = "text";
              toggleIcon.classList.replace("bi-eye", "bi-eye-slash");
          } else {
              passwordField.type = "password";
              toggleIcon.classList.replace("bi-eye-slash", "bi-eye");
          }
      });
  
      function applyMask(input, mask) {
          let i = 0;
          const cleanValue = input.value.replace(/\D/g, "");
          input.value = mask.replace(/0/g, () => cleanValue[i++] || "");
      }
  
      usernameField.addEventListener("input", function () {
          if (userType.value === "instituicao") applyMask(usernameField, "00.000.000/0000-00");
          if (userType.value === "profissional") applyMask(usernameField, "000.000.000-00");
      });
  });
  </script>
  